name: Update Mirrors
on:
  push:
    tags:
      - main
  workflow_dispatch:
  schedule: # Schedule to run twice a day at 8:00 AM and 8:00 PM
    - cron: '0 8,20 * * *'

concurrency:
  group: update-mirrors-${{ github.ref }}
  cancel-in-progress: true
jobs:
  update-mirrors:
    runs-on: ubuntu-latest
    environment: integration
    strategy:
      fail-fast: false
      matrix:
        mirror:
          # note library just means it is part of the official library
          - name: library/postgres
            expression: '^[0-9]+\.[0-9]+$'
          - name: ethereum/client-go
            expression: '^(alltools-v|v)[0-9]\.[0-9]+\.[0-9]+$'
          - name: friendsofgo/killgrave
            expression: '^v?[0-9]+\.[0-9]+\.[0-9]+$'
          - name: mockserver/mockserver
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          - name: testcontainers/ryuk
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          - name: confluentinc/cp-kafka
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          - name: confluentinc/cp-schema-registry
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          - name: confluentinc/cp-zookeeper
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          - name: hyperledger/besu
            expression: '^[0-9]+\.[0-9]+(\.[0-9]+)?$'
            page_size: 300
          - name: thorax/erigon
            expression: '^v[0-9]+\.[0-9]+\.[0-9]+$'
          - name: nethermind/nethermind
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          - name: ghcr.io/paradigmxyz/reth
            expression: '^v[0-9]+\.[0-9]+\.[0-9]+$'
          - name: wiremock/wiremock
            expression: '^[0-9]+\.[0-9]+\.[0-9]+$'
          # disabled until gcloud auth is added
          # - name: gcr.io/prysmaticlabs/prysm/beacon-chain
          #   expression: '^v[0-9]+\.[0-9]+\.[0-9]+$'
          # - name: gcr.io/prysmaticlabs/prysm/validator
          #   expression: '^v[0-9]+\.[0-9]+\.[0-9]+$'
          - name: tofelb/ethereum-genesis-generator
            expression: '^[0-9]+\.[0-9]+\.[0-9]+(\-slots\-per\-epoch)?'
    # This one only has latest tag, probably only want to update it when we know for sure it's a new version we want
    #  - name: protolambda/eth2-val-tools
    #   expression: 'latest'
    permissions:
      id-token: write
      contents: read
      packages: read
    steps:
      - name: Setup GitHub Token
        id: setup-github-token
        uses: smartcontractkit/.github/actions/setup-github-token@9e7cc0779934cae4a9028b8588c9adb64d8ce68c # setup-github-token@0.1.2
        with:
          aws-role-arn: ${{ secrets.GATI_LAMBDA_ARN_ROLE_READ_PACKAGES }}
          aws-lambda-url: ${{ secrets.GATI_LAMBDA_URL }}
          aws-region: ${{ secrets.QA_AWS_REGION }}
          aws-role-duration-seconds: "1800" # this is optional and defaults to 900
      - name: Update image
        uses: smartcontractkit/chainlink-testing-framework/.github/actions/update-internal-mirrors@fe88127c544a4c5cd3247e1149f446a638394d25
        with:
          aws_region: ${{ secrets.QA_AWS_REGION }}
          role_to_assume: ${{ secrets.QA_AWS_ROLE_TO_ASSUME }}
          aws_account_number: ${{ secrets.QA_AWS_ACCOUNT_NUMBER }}
          image_name: ${{matrix.mirror.name}}
          expression: ${{matrix.mirror.expression}}
          page_size: ${{matrix.mirror.page_size}}
          github_token: ${{ steps.setup-github-token.outputs.access-token }} # needed only for checking GHRC.io repositories

  update-other-images:
    runs-on: ubuntu-latest
    environment: integration
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Update other images
        uses: smartcontractkit/chainlink-testing-framework/.github/actions/update-internal-mirrors@4dcb58fdc5e64465370bf59f4f9a230a0829d118
        with:
          aws_region: ${{ secrets.QA_AWS_REGION }}
          role_to_assume: ${{ secrets.QA_AWS_ROLE_TO_ASSUME }}
          aws_account_number: ${{ secrets.QA_AWS_ACCOUNT_NUMBER }}
