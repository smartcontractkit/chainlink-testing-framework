global:
  scrape_interval: 10s

scrape_configs:
  - job_name: 'otel-collector'
    scrape_interval: 10s
    static_configs:
      - targets: [ 'otel-collector:8889' ]
  - job_name: 'ctf'
    metrics_path: /metrics
    docker_sd_configs:
      - host: 'unix:///var/run/docker.sock'
        refresh_interval: 20s
    relabel_configs:
      - source_labels: [__meta_docker_port_private]
        regex: '6688'
        action: keep
  - job_name: cadvisor
    scrape_interval: 10s
    static_configs:
      - targets:
          - cadvisor:8080
    metric_relabel_configs:
      # Extract hex ID from common cgroup/runtime formats:
      # /docker/<id>, docker-<id>.scope, containerd://<id>, cri-containerd-<id>.scope, etc.
      - source_labels: [ id ]
        regex: '.*(?:/docker/|docker-|containerd://|containerd-|cri-containerd-|crio-)([a-f0-9]{12,64})(?:\.scope)?.*'
        target_label: container_id
        replacement: '$1'
        action: replace
  - job_name: 'postgres_exporter_0'
    static_configs:
      - targets: ['postgres_exporter_0:9187']
  - job_name: 'postgres_exporter_1'
    static_configs:
      - targets: ['postgres_exporter_1:9187']
  - job_name: 'postgres_exporter_2'
    static_configs:
      - targets: ['postgres_exporter_2:9187']
  - job_name: 'postgres_exporter_3'
    static_configs:
      - targets: ['postgres_exporter_3:9187']
  - job_name: 'postgres_exporter_4'
    static_configs:
      - targets: ['postgres_exporter_4:9187']
  - job_name: 'process_exporter'
    static_configs:
      - targets: ['process-exporter:9256']
    metric_relabel_configs:
      # Extract container id from groupname so we can match it to the container
      - source_labels: [groupname]
        regex: "^[^|]+\\|.*/([a-f0-9]{12,64})$"
        target_label: container_id
        replacement: "$1"
        action: replace

      # We detect the special '/../..' tail and set container_id=host.
      - source_labels: [groupname]
        regex: "^[^|]+\\|/\\.\\./\\.\\.$"
        target_label: container_id
        replacement: "host"
        action: replace

      - source_labels: [groupname]
        regex: "^([^|]+)\\|.*"
        target_label: groupname
        replacement: "$1"
        action: replace
  - job_name: container-sd
    file_sd_configs:
      - files: [ "/etc/prometheus/targets/merged.json" ]
        refresh_interval: 15s